<!doctype html>
<html>
  <head>
    <title>Multinucleo</title>
  </head>
  <body>
    <canvas></canvas>
    <script>
      let lienzo = document.querySelector("canvas");
      lienzo.width = 4000;
      lienzo.height = 6000;
      let contexto = lienzo.getContext("2d");
      
      let imagen = new Image()
      imagen.src = "josevicente.jpg";
      
      let numeronucleos = navigator.hardwareConcurrency
      console.log(numeronucleos)
      let nucleos = []
      
      for(let i = 0;i<numeronucleos;i++){
        nucleos.push(new Worker("procesaimagen.js"))
      }
      
      imagen.onload = function(){
        contexto.drawImage(imagen,0,0);
        for(let i = 0;i<numeronucleos;i++){
          let trozo = contexto.getImageData(0,0+i*1000,4000,0+i*1000+1000).data;
          nucleos[i].postMessage(trozo)               
          
          nucleos[i].onmessage = function(datos){
            console.log(datos.data)
            let origen = contexto.getImageData(0,0+i*1000,4000,0+i*1000+1000)
            for(let i = 0;i<origen.data.length;i+=4){
              origen.data[i] = datos.data[i]
              origen.data[i+1] = datos.data[i+1]
              origen.data[i+2] = datos.data[i+2]
            }
            contexto.putImageData(origen,0,0+i*1000)
            
          }
        }
       
      }
      
    </script>
  </body>
</html>
